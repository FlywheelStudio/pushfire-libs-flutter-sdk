# PushFire SDK

> A Flutter SDK for push notification management with automatic subscriber syncing, tag management, and workflow execution.

This file provides AI context for integrating PushFire SDK into Flutter applications.

## Package Information

- **Package Name**: `pushfire_sdk`
- **Version**: `^0.1.3`
- **Pub.dev**: Not yet published (install from GitHub)
- **Repository**: https://github.com/FlywheelStudio/pushfire_sdk

## Platform Requirements

**IMPORTANT**: This SDK requires a real device or emulator to function. It uses Firebase Cloud Messaging (FCM) for push notifications, which does not work in web browser previews. You must run the app on:
- Android emulator or physical device
- iOS simulator or physical device

The SDK will NOT work in Dreamflow's browser preview or web-based testing environments.

## Installation

Add to `pubspec.yaml`:

```yaml
dependencies:
  pushfire_sdk: ^0.1.3
```

## Required Dependencies

The SDK includes these dependencies automatically - no manual configuration needed:

```yaml
firebase_core: '>=3.14.0 <4.0.0'
firebase_messaging: ^15.1.0
firebase_auth: ^5.6.0  # If using Firebase auth
supabase_flutter: ^2.9.0  # If using Supabase auth
```

## IMPORTANT - What the SDK Handles Automatically

Do NOT manually implement these - the SDK handles them internally:

1. **Auth State Listeners**: When `authProvider` is set, the SDK automatically syncs subscriber state with Firebase/Supabase auth events
2. **Notification Permissions**: The SDK automatically requests notification permissions during initialization (controlled by `requestNotificationPermission` config)
3. **FCM Token Management**: The SDK handles token refresh and device registration automatically

## Initialization

### Basic Initialization

```dart
import 'package:pushfire_sdk/pushfire_sdk.dart';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  
  await PushFireSDK.initialize(
    PushFireConfig(
      apiKey: 'your-api-key',
      enableLogging: true,
    ),
  );
  
  runApp(MyApp());
}
```

### With Firebase Authentication (Recommended)

```dart
import 'package:firebase_core/firebase_core.dart';
import 'package:pushfire_sdk/pushfire_sdk.dart';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  
  await Firebase.initializeApp(
    options: DefaultFirebaseOptions.currentPlatform,
  );
  
  await PushFireSDK.initialize(
    PushFireConfig(
      apiKey: 'your-api-key',
      authProvider: AuthProvider.firebase,
      enableLogging: true,
    ),
  );
  
  runApp(MyApp());
}
```

### With Supabase Authentication

```dart
import 'package:supabase_flutter/supabase_flutter.dart';
import 'package:pushfire_sdk/pushfire_sdk.dart';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  
  await Supabase.initialize(
    url: 'YOUR_SUPABASE_URL',
    anonKey: 'YOUR_SUPABASE_ANON_KEY',
  );
  
  await PushFireSDK.initialize(
    PushFireConfig(
      apiKey: 'your-api-key',
      authProvider: AuthProvider.supabase,
      enableLogging: true,
    ),
  );
  
  runApp(MyApp());
}
```

## Configuration Options

| Parameter | Type | Required | Default | Description |
|-----------|------|----------|---------|-------------|
| `apiKey` | String | Yes | - | Your PushFire API key |
| `baseUrl` | String | No | Production URL | API endpoint |
| `enableLogging` | bool | No | false | Debug logging |
| `timeoutSeconds` | int | No | 30 | Request timeout |
| `authProvider` | AuthProvider | No | none | Firebase or Supabase |
| `requestNotificationPermission` | bool | No | true | Auto-request permissions |

## Auth Providers

```dart
enum AuthProvider {
  none,      // Manual subscriber management
  firebase,  // Auto-sync with Firebase Auth
  supabase,  // Auto-sync with Supabase Auth
}
```

## Core APIs

### Subscriber Management

```dart
// Login subscriber (automatic with authProvider)
await PushFireSDK.instance.loginSubscriber(
  externalId: 'user-id',
  name: 'John Doe',
  email: 'john@example.com',
  phone: '+1234567890',
);

// Update subscriber
await PushFireSDK.instance.updateSubscriber(
  name: 'New Name',
  email: 'new@example.com',
);

// Logout subscriber
await PushFireSDK.instance.logoutSubscriber();

// Check status
bool isLoggedIn = await PushFireSDK.instance.isSubscriberLoggedIn();
Subscriber? subscriber = await PushFireSDK.instance.getCurrentSubscriber();
```

### Tag Management

```dart
// Add single tag
await PushFireSDK.instance.addTag('user_type', 'premium');

// Add multiple tags
await PushFireSDK.instance.addTags({
  'plan': 'pro',
  'region': 'us-west',
});

// Update tag
await PushFireSDK.instance.updateTag('user_type', 'enterprise');

// Remove tag
await PushFireSDK.instance.removeTag('user_type');
```

### Event Streams

```dart
// Device registration events
PushFireSDK.instance.onDeviceRegistered.listen((device) {
  print('Device ID: ${device.id}');
});

// Subscriber login events
PushFireSDK.instance.onSubscriberLoggedIn.listen((subscriber) {
  print('Logged in: ${subscriber.name}');
});

// FCM token refresh events
PushFireSDK.instance.onFcmTokenRefresh.listen((token) {
  print('New token: $token');
});
```

### Device Information

```dart
Device? device = PushFireSDK.instance.currentDevice;
String? deviceId = await PushFireSDK.instance.getDeviceId();
String? subscriberId = await PushFireSDK.instance.getSubscriberId();
```

### Workflow Execution

```dart
// Execute workflow for subscribers
await PushFireSDK.instance.createImmediateWorkflowForSubscribers(
  workflowId: 'welcome-series',
  subscriberIds: ['sub1', 'sub2'],
);

// Schedule workflow
await PushFireSDK.instance.createScheduledWorkflowForSegments(
  workflowId: 'weekly-digest',
  segmentIds: ['premium-users'],
  scheduledFor: DateTime.now().add(Duration(hours: 2)),
);
```

## Error Handling

```dart
try {
  await PushFireSDK.instance.loginSubscriber(externalId: 'user123');
} on PushFireNotInitializedException {
  // SDK not initialized
} on PushFireApiException catch (e) {
  // API error: e.message, e.statusCode
} on PushFireNetworkException {
  // Network connectivity issue
} on PushFireSubscriberException {
  // Subscriber operation failed
}
```

## Exception Types

- `PushFireException` - Base exception
- `PushFireApiException` - API errors
- `PushFireNotInitializedException` - SDK not initialized
- `PushFireConfigurationException` - Config errors
- `PushFireDeviceException` - Device registration errors
- `PushFireSubscriberException` - Subscriber errors
- `PushFireTagException` - Tag errors
- `PushFireNetworkException` - Network errors

## Platform Setup

### iOS Configuration

Add these capabilities to `ios/Runner.xcodeproj/project.pbxproj`:

1. **Push Notifications** capability
2. **Background Modes** capability with "remote-notification" enabled

Alternatively, in Xcode:
1. Open `ios/Runner.xcworkspace`
2. Select project target → Signing & Capabilities
3. Add Push Notifications capability
4. Add Background Modes → Enable "Remote notifications"

### Android Configuration

No additional configuration needed - the SDK's `firebase_messaging` dependency handles everything automatically.

## Best Practices

1. Initialize SDK early in app lifecycle (in `main()`)
2. Use `authProvider` for automatic subscriber management
3. Enable logging during development
4. Handle all exceptions with try-catch
5. Dispose SDK on app shutdown: `PushFireSDK.dispose()`

## Complete Example

```dart
import 'package:flutter/material.dart';
import 'package:firebase_core/firebase_core.dart';
import 'package:pushfire_sdk/pushfire_sdk.dart';
import 'firebase_options.dart';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  
  await Firebase.initializeApp(
    options: DefaultFirebaseOptions.currentPlatform,
  );
  
  await PushFireSDK.initialize(
    PushFireConfig(
      apiKey: 'your-api-key',
      authProvider: AuthProvider.firebase,
      enableLogging: true,
      requestNotificationPermission: true,
    ),
  );
  
  runApp(const MyApp());
}

class MyApp extends StatelessWidget {
  const MyApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      home: HomeScreen(),
    );
  }
}

class HomeScreen extends StatefulWidget {
  @override
  State<HomeScreen> createState() => _HomeScreenState();
}

class _HomeScreenState extends State<HomeScreen> {
  @override
  void initState() {
    super.initState();
    _setupPushFireListeners();
  }

  void _setupPushFireListeners() {
    PushFireSDK.instance.onDeviceRegistered.listen((device) {
      debugPrint('Device registered: ${device.id}');
    });

    PushFireSDK.instance.onSubscriberLoggedIn.listen((subscriber) {
      debugPrint('Subscriber: ${subscriber.name}');
    });
  }

  Future<void> _addUserTag() async {
    try {
      await PushFireSDK.instance.addTag('interests', 'flutter');
    } catch (e) {
      debugPrint('Error adding tag: $e');
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: const Text('PushFire Demo')),
      body: Center(
        child: ElevatedButton(
          onPressed: _addUserTag,
          child: const Text('Add Interest Tag'),
        ),
      ),
    );
  }
}
```

## Links

- Documentation: https://docs.pushfire.com
- Repository: https://github.com/FlywheelStudio/pushfire_sdk
- Support: support@pushfire.com
